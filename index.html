 <!DOCTYPE html>

<! 3D Cloth Simulation                  >
<!                                      >
<! Written by:  Evan Newman             >
<! Date:        February 2020           >
<! Contact      evanmnewman1@gmail.com  >

<html>

<head>

<meta charset="UTF-8">
<title>3D Cloth</title>

<script src='Abubu.js' type='text/javascript'></script>
<script src='testshaders.js' type='text/javascript'></script>
<script src='ClothLib.js' type='text/javascript'></script>

</head>

<body>
<canvas  id="main-canvas" 
         width=512 height=512
         style="border:1px solid #000000;" >
   <!-- This message is displayed if canvas is not available -->
   Your browser does not support the HTML5 canvas tag.
</canvas>

<script>
	console.log('--- 3D Cloth Simulation by Evan Newman ---');

	var modelParams = {
		clothWidth : 5,
		clothHeight : 5,
		timestep : 1,
		displayWidth : 512,
		displayHeight : 512
	}

	var mainCanvas = document.getElementById('main-canvas');
	mainCanvas.width = modelParams.displayWidth;
	mainCanvas.height = modelParams.displayHeight;

	var camera = new CameraMatrixController();

	CameraMatrixController.addListeners(mainCanvas);

	var vertexPoints = genClothGridPoints(modelParams.clothWidth,
											modelParams.clothHeight, 0.25);
	var geometryPoints = genClothGeometryPoints(modelParams.clothWidth,
												modelParams.clothHeight,
												vertexPoints);
	
	var sheetGeometry = {
	    vertices : geometryPoints,
	    noVertices: geometryPoints.length/3, // No of vertices
	    noCoords  : 3, // No of coordinates
	    premitive : 'triangle_strip' ,
	};

	var testSheetSolver = new Abubu.Solver({
		vertexShader : testVS,
		fragmentShader : testSheetFS,
		geometry : sheetGeometry,
		canvas : mainCanvas,
		clear : true,
		uniforms : {
			cameraMatrix : {type: 'mat4', value: camera.getCameraMatrix()}
			//modelMatrix :
		}
	});

	var lineGeometry = {
	    vertices : geometryPoints,
	    noVertices: geometryPoints.length/3, // No of vertices
	    noCoords  : 3, // No of coordinates
	    premitive : 'line_strip' ,
	};

	var testLineSolver = new Abubu.Solver({
		vertexShader : testVS,
		fragmentShader : testLineFS,
		geometry : lineGeometry,
		canvas : mainCanvas,
		clear : false,
		uniforms : {
			cameraMatrix : {type: 'mat4', value: camera.getCameraMatrix()}
		}
	});

	// stuff to cap the frame rate
	var gameState = 0;
	var t0 = performance.now();
	var accumulator = 0;
	var OPTIMAL_DT = 1000/60; // ms per frame

	var render = function() {
		// stuff to cap the frame rate	
		if (gameState <= 1) {
			var t = performance.now()
			accumulator += t - t0

			while (gameState == 0 && accumulator >= OPTIMAL_DT) {
				camera.updateCameraMatrix();
				testSheetSolver.setUniform("cameraMatrix", camera.getCameraMatrix());
				testLineSolver.setUniform("cameraMatrix", camera.getCameraMatrix());
				testSheetSolver.render();
				testLineSolver.render();
				accumulator -= OPTIMAL_DT;
			} 

			t0 = t;
		}
		requestAnimationFrame(render);
	}
	render();

</script>

</body>
</html>